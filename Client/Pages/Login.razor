@page "/"
@using ConsultaPto.Client.Services
@using ConsultaPto.Shared.Models
@inject UsuariosService UsuariosService
@inject SesionUsuarioService SesionUsuario
@inject NavigationManager Nav

<div class="pto-auth-wrapper">

    <div class="pto-auth-card">

        <div class="pto-auth-step-label">
            Inicia sesión
        </div>
        <div class="pto-auth-title">Consulta tus Puntos de Oro</div>
        <div class="pto-auth-subtitle">
            Primero validamos tu documento, luego tu pregunta de seguridad.
        </div>

        @if (!string.IsNullOrEmpty(mensaje))
        {
            <div class="@mensajeClase text-center mb-3" role="alert">
                @mensaje
            </div>
        }

        @* Paso 1: consultar cédula / pasaporte *@
        @if (!mostrarSegundaEtapa)
        {
            <EditForm Model="@cedulaRequest" OnValidSubmit="@ConsultarCedula" class="mt-2">
                <DataAnnotationsValidator />

                <div class="mb-3">
                    <label class="form-label">Cédula o Pasaporte</label>
                    <InputText @bind-Value="cedulaRequest.Cedula"
                               class="form-control rounded-pill" />
                    <ValidationMessage For="@(() => cedulaRequest.Cedula)" class="text-danger small mt-1" />

                    @if (!string.IsNullOrEmpty(cedulaError))
                    {
                        <div class="text-danger small mt-1">@cedulaError</div>
                    }
                    <div class="pto-field-hint mt-1">
                        Ejemplos: <strong>8-1234-5678</strong> (cédula) o <strong>PA1234567</strong> (pasaporte).
                    </div>
                </div>

                <button type="submit"
                        class="btn pto-btn-primary w-100 rounded-pill"
                        disabled="@procesando">
                    @if (procesando)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        <span> Consultando...</span>
                    }
                    else
                    {
                        <span class="text-white">Continuar</span>
                    }
                </button>
            </EditForm>
        }

        @* Paso 2: pregunta de seguridad + correo *@
        @if (mostrarSegundaEtapa)
        {
            <div class="pto-auth-divider"></div>

            <EditForm Model="@loginRequest" OnValidSubmit="@ValidarRespuesta">
                <DataAnnotationsValidator />

                <div class="mb-3">
                    <label class="form-label">Documento</label>
                    <input class="form-control rounded-pill"
                           value="@loginRequest.Cedula"
                           disabled />
                </div>

                <div class="mb-3">
                    <label class="form-label">Pregunta de seguridad</label>
                    <input class="form-control rounded-pill"
                           value="@preguntaSeguridad"
                           disabled />
                </div>

                <div class="mb-3">
                    <label class="form-label">Respuesta</label>
                    <InputText @bind-Value="loginRequest.Respuesta"
                               class="form-control rounded-pill"
                               placeholder="Escribe tu respuesta" />
                    <ValidationMessage For="@(() => loginRequest.Respuesta)" class="text-danger small mt-1" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Correo registrado</label>
                    <InputText @bind-Value="loginRequest.Correo"
                               class="form-control rounded-pill"
                               placeholder="correo@ejemplo.com" />
                    <ValidationMessage For="@(() => loginRequest.Correo)" class="text-danger small mt-1" />
                </div>

                <button type="submit"
                        class="btn btn-success w-100 rounded-pill"
                        disabled="@procesando">
                    @if (procesando)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        <span> Validando...</span>
                    }
                    else
                    {
                        <span>Iniciar sesión</span>
                    }
                </button>
            </EditForm>
        }

    </div>
</div>

@code {
    private CedulaRequest cedulaRequest = new();
    private LoginRequest loginRequest = new();

    private bool mostrarSegundaEtapa = false;
    private bool procesando = false;

    private string? preguntaSeguridad;
    private string? mensaje;
    private string mensajeClase = "";
    private string? cedulaError;

    // Paso 1: Buscar usuario por documento
    private async Task ConsultarCedula()
    {
        mensaje = "";
        cedulaError = null;
        mostrarSegundaEtapa = false;

        var doc = cedulaRequest.Cedula?.Trim();
        if (string.IsNullOrWhiteSpace(doc))
        {
            cedulaError = "El documento es obligatorio.";
            return;
        }

        procesando = true;

        try
        {
            var usuario = await UsuariosService.BuscarUsuarioPorCedula(doc);

            if (usuario != null)
            {
                loginRequest.Cedula = doc;
                loginRequest.Respuesta = string.Empty;
                loginRequest.Correo = string.Empty; // limpiamos por si acaso

                preguntaSeguridad = usuario.PreguntaSeguridad?.Pregunta;
                mostrarSegundaEtapa = true;

                mensajeClase = "alert alert-info";
                mensaje = "Usuario encontrado. Responda su pregunta de seguridad.";
            }
            else
            {
                cedulaError = "No se encontró ningún usuario con ese documento.";
            }
        }
        finally
        {
            procesando = false;
        }
    }

    // Paso 2: Validar respuesta + correo
    private async Task ValidarRespuesta()
    {
        mensaje = "";
        procesando = true;

        try
        {
            // Determinar tipo de documento ANTES de llamar al API
            var tipoDocumento = DetectarTipoDocumento(loginRequest.Cedula);
            loginRequest.TipoDocumento = tipoDocumento;

            var loginValido = await UsuariosService.ValidarLogin(loginRequest);

            if (loginValido)
            {
                // Guardar en sesión para usar en el Dashboard
                SesionUsuario.IniciarSesion(loginRequest.Cedula, tipoDocumento);

                mensajeClase = "alert alert-success";
                mensaje = "✅ Inicio de sesión exitoso.";

                Nav.NavigateTo("/dashboard", replace: true);
            }
            else
            {
                mensajeClase = "alert alert-danger";
                mensaje = "❌ Datos de validación incorrectos.";
            }
        }
        finally
        {
            procesando = false;
        }
    }

    private string DetectarTipoDocumento(string? documento)
    {
        if (string.IsNullOrWhiteSpace(documento))
            return "0"; // por defecto

        documento = documento.Trim();

        // Regla simple:
        //  - si contiene alguna letra => pasaporte (1)
        //  - si solo tiene dígitos, espacios, guiones => cédula (0)
        return documento.Any(char.IsLetter) ? "1" : "0";
    }
}
