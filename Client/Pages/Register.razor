@page "/register"
@using System.Net
@using ConsultaPto.Client.Services
@using ConsultaPto.Shared.Models
@inject UsuariosService UsuariosService
@inject NavigationManager Nav

@if (preguntas == null)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3"><em>Cargando preguntas...</em></p>
    </div>
}
else
{
    <div class="pto-auth-wrapper">
        <div class="pto-auth-card pto-register-card">

            <div class="pto-auth-logo">
                <img src="/images/form_logo.png" alt="Consulta tus puntos de oro" />
            </div>

            <div class="pto-auth-title text-center">
                Crea tu usuario
            </div>
            <div class="pto-auth-subtitle text-center mb-3">
                Regístrate para poder consultar tus Puntos de Oro y beneficios.
            </div>

            @if (!string.IsNullOrEmpty(mensaje))
            {
                <div class="@mensajeClase fade show mt-2 text-center" role="alert">
                    @mensaje
                </div>
            }

            <EditForm Model="@usuario" OnValidSubmit="@GuardarUsuario" class="mt-3">
                <DataAnnotationsValidator />

                <div class="row g-3">
                    <!-- Columna izquierda -->
                    <div class="col-12 col-md-6">
                        <div class="form-floating mb-3">
                            <InputText id="nombreInput" @bind-Value="usuario.Nombre"
                                       class="form-control rounded-pill"
                                       placeholder="Nombre completo" />
                            <label for="nombreInput">Nombre completo</label>
                            <ValidationMessage For="@(() => usuario.Nombre)" class="text-danger small mt-1" />
                        </div>

                        <div class="form-floating mb-1">
                            <InputText id="cedulaInput" @bind-Value="usuario.Cedula"
                                       class="form-control rounded-pill"
                                       placeholder="Cédula o pasaporte" />
                            <label for="cedulaInput">Cédula o pasaporte</label>
                            <ValidationMessage For="@(() => usuario.Cedula)" class="text-danger small mt-1" />
                        </div>
                        <div class="pto-field-hint mb-3">
                            Usa el mismo formato que utilizarás para iniciar sesión
                            (ej. <strong>8-1004-1416</strong> o <strong>PA1234567</strong>).
                        </div>

                        
                    </div>

                    <!-- Columna derecha -->
                    <div class="col-12 col-md-6">
                        <div class="form-floating mb-3">
                            <InputSelect id="preguntaInput" @bind-Value="usuario.IdPregunta"
                                         class="form-select rounded-pill">
                                <option value="">Seleccione...</option>
                                @foreach (var p in preguntas)
                                {
                                    <option value="@p.Id">@p.Pregunta</option>
                                }
                            </InputSelect>
                            <label for="preguntaInput">Pregunta de seguridad</label>
                            <ValidationMessage For="@(() => usuario.IdPregunta)" class="text-danger small mt-1" />
                        </div>

                        <div class="form-floating mb-4">
                            <InputText id="respuestaInput" @bind-Value="usuario.Respuesta"
                                       class="form-control rounded-pill"
                                       placeholder="Respuesta" />
                            <label for="respuestaInput">Respuesta</label>
                            <ValidationMessage For="@(() => usuario.Respuesta)" class="text-danger small mt-1" />
                        </div>

                        <div class="text-end mt-1">
                            <button type="submit"
                                    class="btn pto-btn-primary px-5 rounded-pill shadow-sm text-white font-weight-bold"
                                    disabled="@procesando">
                                @if (procesando)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"
                                          role="status" aria-hidden="true"></span>
                                    <span>Guardando...</span>
                                }
                                else
                                {
                                    <span>Registrar</span>
                                }
                            </button>
                        </div>
                    </div>
                </div>
                <div class="mt-1 d-flex justify-content-center align-items-center">
                    <span class="text-muted small">
                        ¿Ya te registraste antes?
                        @* Link a la página de inicio de sesión (ruta "/") *@
                        <a href="/" class="ms-1">Inicia sesión aquí</a>
                    </span>
                </div>
            </EditForm>
        </div>
    </div>
}

@code {
    private Usuario usuario = new();
    private List<PreguntaSeguridad>? preguntas;

    private string? mensaje;
    private string mensajeClase = "";
    private bool procesando = false;

    protected override async Task OnInitializedAsync()
    {
        preguntas = await UsuariosService.GetPreguntas();
    }

    private async Task GuardarUsuario()
    {
        procesando = true;
        mensaje = null;
        StateHasChanged();

        try
        {
            // Nuevo método que devuelve HttpResponseMessage
            var response = await UsuariosService.RegistrarUsuarioResponse(usuario);

            if (response.StatusCode == HttpStatusCode.Conflict)
            {
                mensaje = "❌ Ya existe un usuario registrado con ese documento.";
                mensajeClase = "alert alert-danger mt-2";
                return;
            }

            response.EnsureSuccessStatusCode();

            mensaje = "✅ Usuario registrado con éxito. Redirigiendo al inicio de sesión...";
            mensajeClase = "alert alert-success mt-2";

            // Limpiar formulario
            usuario = new Usuario();
            StateHasChanged();

            // Pequeña pausa para que el usuario vea el mensaje
            await Task.Delay(2000);

            // 🔹 Redirigir automáticamente al login (ruta raíz "/")
            Nav.NavigateTo("/");
        }
        catch (Exception ex)
        {
            mensaje = $"❌ Error al registrar: {ex.Message}";
            mensajeClase = "alert alert-danger mt-2";
        }
        finally
        {
            procesando = false;
            StateHasChanged();
        }
    }
}
